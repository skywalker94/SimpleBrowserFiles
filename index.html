<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Browser Files</title>
  <link rel="stylesheet" href="assets/site.css" />
</head>
<body>
  <main class="wrap">
    <header class="site-head">
      <div class="title-row">
        <h1>Simple Browser Files</h1>
        <span class="badge">dev</span>
      </div>
      <p class="lead">Small static file host. Add files to <code>files/</code> grouped by category (subfolders), or edit <code>files/files.json</code>.</p>
      <p class="meta">Categories: Entertaining • Fan Fiction • Memories • World — add more by creating new subfolders.</p>
    </header>

    <section id="controls" class="controls" aria-hidden="false">
      <label for="search" class="visually-hidden">Search files</label>
      <div class="search-row">
        <input id="search" placeholder="Search files — type a name or description" aria-label="Search files" />
        <button id="clearSearch" class="icon-btn" title="Clear search" aria-label="Clear search" hidden>
          <!-- X icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M18 6L6 18M6 6l12 12"></path></svg>
        </button>
      </div>
    </section>

    <section id="content" class="content" aria-live="polite"></section>

    <footer class="site-foot">
      <p>Hosted on GitHub Pages — repo:
        <a href="https://github.com/skywalker94/SimpleBrowserFiles" target="_blank" rel="noopener">skywalker94/SimpleBrowserFiles</a>
      </p>
      <p class="foot-note">Tip: add files to <code>files/&lt;Category&gt;/</code> and push to update. Use the auto-generator action if you want the manifest created automatically.</p>
    </footer>
  </main>

<script>
  const FILES_JSON = 'files/files.json';
  const STORAGE_KEY = 'sbf:openCategories';

  function escapeHtml(s) {
    return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // Create a card for each file. card clickable opens file; download button separately.
  function makeFileCard(item) {
    const url = new URL(item.path, location.href).href;
    const ext = (item.path.split('.').pop() || '').toLowerCase();
    const title = escapeHtml(item.title || item.name);
    const desc = escapeHtml(item.description || '');

    // Use template with data attributes for download fallback
    return `
      <article class="file" data-path="${escapeHtml(item.path)}" tabindex="0">
        <a class="file-link" href="${url}" target="_blank" rel="noopener" aria-label="Open ${title}">
          <div class="file-meta">
            <strong class="file-title">${title}</strong>
            <div class="file-sub">${desc}</div>
          </div>
          <div class="file-ext" aria-hidden="true">${escapeHtml(ext)}</div>
        </a>

        <div class="file-actions">
          <a class="btn btn-open" href="${url}" target="_blank" rel="noopener" title="Open ${title}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12s4-8 9-8 9 8 9 8-4 8-9 8-9-8-9-8z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Open
          </a>
          <button class="btn btn-download" data-path="${escapeHtml(item.path)}" title="Download ${title}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21H3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            Download
          </button>
        </div>
      </article>
    `;
  }

  // Build category accordion block
  function makeCategoryBlock(cat, isOpen) {
    const id = 'cat-' + encodeURIComponent(cat.name).replace(/%/g,'');
    let inner = '';
    (cat.items || []).forEach(item => inner += makeFileCard(item));
    if (!inner) inner = '<p class="empty">No files in this category.</p>';

    return `
      <section class="category ${isOpen ? 'open' : 'collapsed'}" data-name="${escapeHtml(cat.name)}" id="${id}">
        <button class="cat-toggle" aria-expanded="${isOpen ? 'true' : 'false'}" aria-controls="${id}-panel">
          <div class="cat-title">
            <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>${escapeHtml(cat.name)}</span>
          </div>
          <div class="cat-meta">
            <span class="cat-count">${(cat.items || []).length}</span>
          </div>
        </button>

        <div id="${id}-panel" class="cat-panel" role="region" aria-labelledby="${id}">
          <div class="files-grid">${inner}</div>
        </div>
      </section>
    `;
  }

  // Render categories & files from data object
  function render(data) {
    const content = document.getElementById('content');
    if (!data || !Array.isArray(data.categories)) {
      content.innerHTML = '<p class="err">No files manifest found. Add <code>files/files.json</code> or enable the auto-generator.</p>';
      return;
    }

    const stored = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let html = '';
    data.categories.forEach(cat => {
      const isOpen = stored.indexOf(cat.name) !== -1 || stored.length === 0; // default open if nothing saved
      html += makeCategoryBlock(cat, isOpen);
    });
    content.innerHTML = html;

    // Add listeners: accordion toggles, download actions, card keyboard open
    content.querySelectorAll('.cat-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const section = btn.closest('.category');
        const name = section.getAttribute('data-name');
        const panel = section.querySelector('.cat-panel');
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
        section.classList.toggle('open', !expanded);
        section.classList.toggle('collapsed', expanded);
        panel.style.maxHeight = !expanded ? panel.scrollHeight + 'px' : '0px';

        // persist open list
        const list = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));
        if (!expanded) list.add(name); else list.delete(name);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(list)));
      });

      // Set initial panel maxHeight (for smooth open)
      const section = btn.closest('.category');
      const panel = section.querySelector('.cat-panel');
      if (section.classList.contains('open')) panel.style.maxHeight = panel.scrollHeight + 'px';
      else panel.style.maxHeight = '0px';
    });

    // Download handling (delegated)
    content.addEventListener('click', async (ev) => {
      const dl = ev.target.closest('.btn-download');
      if (!dl) return;
      ev.preventDefault();
      const path = dl.getAttribute('data-path');
      if (!path) return;

      // Attempt to trigger native download via an anchor first
      try {
        const a = document.createElement('a');
        a.href = new URL(path, location.href).href;
        // set download attribute (may be ignored for some content-types)
        const filename = path.split('/').pop();
        a.setAttribute('download', filename);
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (e) {
        // fallback: fetch blob and save
        await fetchAndSave(path, dl);
      }

      // micro-feedback
      const txt = dl.innerHTML;
      dl.classList.add('pressed');
      dl.innerText = 'Downloaded';
      setTimeout(() => { dl.classList.remove('pressed'); dl.innerHTML = txt; }, 1400);
    });

    // keyboard open on Enter/Space for article cards
    content.addEventListener('keydown', (ev) => {
      const card = ev.target.closest('.file');
      if (!card) return;
      if (ev.key === 'Enter' || ev.key === ' ') {
        ev.preventDefault();
        const link = card.querySelector('.file-link');
        if (link) link.click();
      }
    }, true);
  }

  // robust fetch & save (fallback helper)
  async function fetchAndSave(path, buttonEl) {
    try {
      const resp = await fetch(path);
      if (!resp.ok) throw new Error('Network response was not ok');
      const blob = await resp.blob();
      const filename = path.split('/').pop();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error('Download failed', err);
      if (buttonEl) {
        const old = buttonEl.innerHTML;
        buttonEl.innerText = 'Failed';
        setTimeout(()=> buttonEl.innerHTML = old, 1600);
      }
    }
  }

  // Search + UI glue
  (function init() {
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('clearSearch');

    function filterAndRender(data, q) {
      const filtered = {
        categories: data.categories.map(cat => {
          const items = (cat.items || []).filter(item => {
            if (!q) return true;
            const s = (item.title + ' ' + (item.description || '') + ' ' + item.name).toLowerCase();
            return s.includes(q.toLowerCase());
          });
          return { name: cat.name, items };
        })
      };
      render(filtered);
    }

    // initial load
    fetch(FILES_JSON)
      .then(r => {
        if (!r.ok) throw new Error('Could not load files.json (HTTP ' + r.status + ')');
        return r.json();
      })
      .then(data => {
        // render initially full dataset
        filterAndRender(data, '');
        // wire search live (debounce tiny)
        let to = null;
        searchInput.addEventListener('input', () => {
          const v = searchInput.value.trim();
          clearBtn.hidden = v === '';
          if (to) clearTimeout(to);
          to = setTimeout(() => filterAndRender(data, v), 140);
        });
        clearBtn.addEventListener('click', () => {
          searchInput.value = '';
          clearBtn.hidden = true;
          filterAndRender(data, '');
          searchInput.focus();
        });
      })
      .catch(() => {
        document.getElementById('content').innerHTML = `<p class="err">Failed loading files manifest. See README or enable the auto-generator.</p>`;
      });

    // keyboard shortcut: "/" focuses search
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
        e.preventDefault();
        searchInput.focus();
      }
    });
  })();
</script>
</body>
</html>
