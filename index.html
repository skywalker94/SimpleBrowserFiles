<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Browser Files</title>
  <link rel="stylesheet" href="assets/site.css" />
</head>
<body>
  <main class="wrap">
    <header class="site-head">
      <div class="top">
        <h1>Simple Browser Files</h1>
        <span class="tag">lightweight</span>
      </div>
      <p class="lead">A clean static site for hosting small files. Drop files into <code>files/&lt;Category&gt;/</code> and push to main and <code>files/files.json</code> will be updated with the GitHub Actions generator.</p>
    </header>

    <section class="controls">
      <label for="search" class="sr-only">Search files</label>
      <div class="search-wrap">
        <input id="search" type="search" placeholder="Search files by name or description — press / to focus" aria-label="Search files" />
        <button id="clearSearch" class="icon" aria-label="Clear search" title="Clear" hidden>&times;</button>
      </div>
    </section>

    <nav class="cats" id="content" aria-live="polite">
      <!-- categories & files are rendered here -->
    </nav>

    <footer class="site-foot">
      <p>Hosted on GitHub Pages — repo: <a href="https://github.com/skywalker94/SimpleBrowserFiles" target="_blank" rel="noopener">skywalker94/SimpleBrowserFiles</a></p>
    </footer>
  </main>

<script>
const FILES_JSON = 'files/files.json';

// small helper
function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// Build a file card (always shows Download + Open)
function fileCard(item){
  const url = new URL(item.path, location.href).href;
  const filename = (item.path || '').split('/').pop() || (item.name||'file');
  const ext = filename.split('.').pop().toLowerCase();
  const title = esc(item.title || filename);
  const desc = esc(item.description || '');
  return `
    <article class="card" data-path="${esc(item.path)}" tabindex="0">
      <div class="card-main">
        <div class="card-left">
          <div class="card-title">${title}</div>
          <div class="card-desc">${desc}</div>
        </div>
        <div class="card-right">
          <div class="ext">${esc(ext)}</div>
        </div>
      </div>

      <div class="card-actions">
        <a class="btn open" href="${url}" target="_blank" rel="noopener" aria-label="Open ${title}">Open</a>
        <button class="btn download" data-path="${esc(item.path)}" aria-label="Download ${title}">Download</button>
      </div>
    </article>
  `;
}

// Build category block
function categoryBlock(cat){
  const items = cat.items || [];
  const filesHtml = items.map(fileCard).join('');
  return `
    <section class="category">
      <h2 class="cat-title">${esc(cat.name)} <span class="count">(${items.length})</span></h2>
      <div class="grid">${filesHtml || '<p class="empty">No files</p>'}</div>
    </section>
  `;
}

// Render function: accepts data { categories: [...] }
function render(data){
  const container = document.getElementById('content');
  if(!data || !Array.isArray(data.categories)){
    container.innerHTML = '<p class="error">No files manifest found. Add <code>files/files.json</code> or enable the auto-generator.</p>';
    return;
  }
  container.innerHTML = data.categories.map(categoryBlock).join('');
  attachInteractions();
}

// Attach click handlers for download + keyboard open
function attachInteractions(){
  const content = document.getElementById('content');

  // Download handler (delegated)
  content.addEventListener('click', async (e) => {
    const dlBtn = e.target.closest('.btn.download');
    if(!dlBtn) return;
    e.preventDefault();
    const path = dlBtn.getAttribute('data-path');
    if(!path) return;
    // first try native anchor download
    const url = new URL(path, location.href).href;
    try {
      const a = document.createElement('a');
      a.href = url;
      const filename = path.split('/').pop();
      a.setAttribute('download', filename);
      a.style.display='none';
      document.body.appendChild(a);
      a.click();
      a.remove();
      showTempState(dlBtn, 'Downloaded');
      return;
    } catch (err) {
      // fallback
    }
    // fallback: fetch and save blob
    try {
      const resp = await fetch(path);
      if(!resp.ok) throw new Error('Network error');
      const blob = await resp.blob();
      const blobUrl = URL.createObjectURL(blob);
      const a2 = document.createElement('a');
      a2.href = blobUrl;
      a2.download = path.split('/').pop();
      document.body.appendChild(a2);
      a2.click();
      a2.remove();
      URL.revokeObjectURL(blobUrl);
      showTempState(dlBtn, 'Downloaded');
    } catch (err) {
      console.error('Download failed', err);
      showTempState(dlBtn, 'Failed');
    }
  });

  // keyboard: Enter or Space on card opens file link
  content.addEventListener('keydown', (e) => {
    const card = e.target.closest('.card');
    if(!card) return;
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      const link = card.querySelector('.btn.open');
      if(link) link.click();
    }
  }, true);
}

function showTempState(buttonEl, text){
  const orig = buttonEl.innerHTML;
  buttonEl.textContent = text;
  buttonEl.disabled = true;
  setTimeout(()=>{ buttonEl.innerHTML = orig; buttonEl.disabled = false; }, 1400);
}

// Search logic (debounced)
function setupSearch(data){
  const input = document.getElementById('search');
  const clearBtn = document.getElementById('clearSearch');

  function filter(q){
    q = (q||'').trim().toLowerCase();
    if(!q){
      render(data);
      clearBtn.hidden = true;
      return;
    }
    clearBtn.hidden = false;
    const filtered = {
      categories: data.categories.map(cat => {
        const items = (cat.items||[]).filter(it=>{
          const hay = ((it.title||it.name||'') + ' ' + (it.description||'') + ' ' + (it.name||'')).toLowerCase();
          return hay.includes(q);
        });
        return { name: cat.name, items };
      }).filter(c => (c.items && c.items.length)) // hide empty categories when searching
    };
    render(filtered);
  }

  let t = null;
  input.addEventListener('input', () => {
    clearTimeout(t);
    t = setTimeout(()=> filter(input.value), 160);
  });
  clearBtn.addEventListener('click', () => { input.value = ''; clearBtn.hidden = true; render(data); input.focus(); });
  // "/" focus shortcut
  document.addEventListener('keydown', (e) => {
    if(e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){
      e.preventDefault(); input.focus();
    }
  });
}

// Boot
fetch(FILES_JSON)
  .then(r => { if(!r.ok) throw new Error('Failed to load'); return r.json(); })
  .then(data => {
    render(data);
    setupSearch(data);
  })
  .catch(err => {
    console.error(err);
    const content = document.getElementById('content');
    content.innerHTML = '<p class="error">Failed loading files manifest. See README or enable the auto-generator.</p>';
  });
</script>
</body>
</html>
